<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Use a multi-core cluster — cluster • raster</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Use a multi-core cluster — cluster"><meta property="og:description" content="beginCluster creates, and endCluster deletes a 'snow' cluster object. This object can be used for multi-core computing with those 'raster' functions that support it.
beginCluster determines the number of nodes (cores) that are available and uses all of them (unless the argument n is used).
NOTE: beginCluster may fail when the package 'nws' is installed. You can fix that by removing the 'nws' package, or by setting the cluster type manually, e.g. beginCluster(type=&quot;SOCK&quot;)
endCluster closes the cluster and removes the object.
The use of the cluster is automatic in these functions: projectRaster, resample and in extract when using polygons.
clusterR is a flexible interface for using cluster with other functions. This function only works with functions that have a Raster* object as first argument and that operate on a cell by cell basis (i.e., there is no effect of neigboring cells) and return an object with the same number of cells as the input raster object. The first argument of the function called must be a Raster* object. There can only be one Raster* object argument. For example, it works with calc and it also works with overlay as long as you provide a single RasterStack or RasterBrick as the first argument.
This function is particularly useful to speed up computations in functions like predict, interpolate, and perhaps calc.
Among other functions, it does _not_ work with merge, crop, mosaic, (dis)aggregate, resample, projectRaster, focal, distance, buffer, direction. But note that projectRaster has a build-in capacity for clustering that is automatically used if beginCluster() has been called."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">raster</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">3.5-18</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/rspatial/raster/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Use a multi-core cluster</h1>
    
    <div class="hidden name"><code>cluster.Rd</code></div>
    </div>

    <div class="ref-description">
    <p><code>beginCluster</code> creates, and <code>endCluster</code> deletes a 'snow' cluster object. This object can be used for multi-core computing with those 'raster' functions that support it.</p>
<p><code>beginCluster</code> determines the number of nodes (cores) that are available and uses all of them (unless the argument <code>n</code> is used).</p>
<p>NOTE: beginCluster may fail when the package 'nws' is installed. You can fix that by removing the 'nws' package, or by setting the cluster type manually, e.g. <code>beginCluster(type="SOCK")</code></p>
<p>endCluster closes the cluster and removes the object.</p>
<p>The use of the cluster is automatic in these functions: <code><a href="projectRaster.html">projectRaster</a></code>, <code><a href="resample.html">resample</a></code> and in <code><a href="extract.html">extract</a></code> when using polygons.</p>
<p><code>clusterR</code> is a flexible interface for using cluster with other functions. This function only works with functions that have a Raster* object as first argument and that operate on a cell by cell basis (i.e., there is no effect of neigboring cells) and return an object with the same number of cells as the input raster object. The first argument of the function called must be a Raster* object. There can only be one Raster* object argument. For example, it works with <code><a href="calc.html">calc</a></code> and it also works with <code><a href="overlay.html">overlay</a></code> as long as you provide a single RasterStack or RasterBrick as the first argument.</p>
<p>This function is particularly useful to speed up computations in functions like predict, interpolate, and perhaps calc.</p>
<p>Among other functions, it does _not_ work with merge, crop, mosaic, (dis)aggregate, resample, projectRaster, focal, distance, buffer, direction. But note that projectRaster has a build-in capacity for clustering that is automatically used if beginCluster() has been called.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="fu">beginCluster</span><span class="op">(</span><span class="va">n</span>, type<span class="op">=</span><span class="st">'SOCK'</span>, <span class="va">nice</span>, <span class="va">exclude</span><span class="op">)</span>
<span class="fu">endCluster</span><span class="op">(</span><span class="op">)</span>
<span class="fu">clusterR</span><span class="op">(</span><span class="va">x</span>, <span class="va">fun</span>, args<span class="op">=</span><span class="cn">NULL</span>, export<span class="op">=</span><span class="cn">NULL</span>, filename<span class="op">=</span><span class="st">''</span>, cl<span class="op">=</span><span class="cn">NULL</span>, m<span class="op">=</span><span class="fl">2</span>, <span class="va">...</span><span class="op">)</span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>n</dt>
<dd><p>Integer. The number of nodes to be used (optional)</p></dd>
<dt>type</dt>
<dd><p>Character. The cluster type to be used</p></dd>
<dt>nice</dt>
<dd><p>Integer. To set the prioirty for the workers, between -20 and 20 (UNIX like platforms only)</p></dd>
<dt>exclude</dt>
<dd><p>Character. Packages to exclude from loading on the nodes (because they may fail there) but are required/loaded on the master</p></dd>
<dt>x</dt>
<dd><p>Raster* object</p></dd>
<dt>fun</dt>
<dd><p>function that takes <code>x</code> as its first argument</p></dd>
<dt>args</dt>
<dd><p>list with the arguments for the function (excluding <code>x</code>, which should always be the first argument</p></dd>
<dt>export</dt>
<dd><p>character. Vector of variable names to export to the cluster nodes such that the are visible to fun (e.g. a parameter that is not passed as an argument)</p></dd>
<dt>filename</dt>
<dd><p>character. Output filename (optional)</p></dd>
<dt>cl</dt>
<dd><p>cluster object (do not use it if beginCluster() has been called</p></dd>
<dt>m</dt>
<dd><p>tuning parameter to determine how many blocks should be used. The number is rounded and multiplied with the number of nodes.</p></dd>
<dt>...</dt>
<dd><p>additional arguments as for <code><a href="writeRaster.html">writeRaster</a></code></p></dd>
</dl></div>
    <div id="note">
    <h2>Note</h2>
    <p>If you want to write your own cluster-enabled functions see <code><a href="programming.html">getCluster</a>, <a href="programming.html">returnCluster</a></code>, and the vignette about writing functions.</p>
    </div>
    <div id="value">
    <h2>Value</h2>
    <p>beginCluster and endCluster: None. The side effect is to create or delete a cluster object.
clusterR: as for the function called with argument <code>fun</code></p>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Matteo Mattiuzzi and Robert J. Hijmans</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"></span>
<span class="r-in"><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span class="r-in"><span class="co"># set up the cluster object for parallel computing</span></span>
<span class="r-in"><span class="fu">beginCluster</span><span class="op">(</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="raster.html">raster</a></span><span class="op">(</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="getValues.html">values</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="ncell.html">ncell</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">clusterR</span><span class="op">(</span><span class="va">r</span>, <span class="va">sqrt</span>, verbose<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">f1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="calc.html">calc</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">sqrt</span><span class="op">)</span></span>
<span class="r-in"><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">clusterR</span><span class="op">(</span><span class="va">r</span>, <span class="va">f1</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="stack.html">stack</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">r</span><span class="op">*</span><span class="fl">2</span>, <span class="va">r</span><span class="op">*</span><span class="fl">3</span><span class="op">)</span></span>
<span class="r-in"><span class="va">f2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>,<span class="va">e</span>,<span class="va">f</span><span class="op">)</span> <span class="op">(</span><span class="va">d</span> <span class="op">+</span> <span class="va">e</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">f</span> <span class="op">*</span> <span class="va">param</span><span class="op">)</span></span>
<span class="r-in"><span class="va">param</span> <span class="op">&lt;-</span> <span class="fl">122</span></span>
<span class="r-in"><span class="va">ov</span> <span class="op">&lt;-</span> <span class="fu">clusterR</span><span class="op">(</span><span class="va">s</span>, <span class="va">overlay</span>, args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun<span class="op">=</span><span class="va">f2</span><span class="op">)</span>, export<span class="op">=</span><span class="st">'param'</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>, <span class="fl">45</span>,<span class="fl">45</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">2</span>, byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span class="r-in"><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">clusterR</span><span class="op">(</span><span class="va">r</span>, <span class="va">distanceFromPoints</span>, args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>xy<span class="op">=</span><span class="va">pts</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="fu"><a href="getValues.html">values</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="ncell.html">ncell</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span>, <span class="fl">1</span>,  <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">2</span>,  <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span></span>
<span class="r-in"><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">m</span>, ncol<span class="op">=</span><span class="fl">3</span>, byrow<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span class="r-in"><span class="va">rc1</span> <span class="op">&lt;-</span> <span class="fu">clusterR</span><span class="op">(</span><span class="va">r</span>, <span class="va">reclassify</span>, args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>rcl<span class="op">=</span><span class="va">m</span>, right<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>, </span>
<span class="r-in">               filename<span class="op">=</span><span class="fu"><a href="rasterTmpFile.html">rasterTmpFile</a></span><span class="op">(</span><span class="op">)</span>, datatype<span class="op">=</span><span class="st">'INT2S'</span>, overwrite<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># equivalent to:</span></span>
<span class="r-in"><span class="va">rc2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reclassify.html">reclassify</a></span><span class="op">(</span><span class="va">r</span>, rcl<span class="op">=</span><span class="va">m</span>, right<span class="op">=</span><span class="cn">FALSE</span>, filename<span class="op">=</span><span class="fu"><a href="rasterTmpFile.html">rasterTmpFile</a></span><span class="op">(</span><span class="op">)</span>, datatype<span class="op">=</span><span class="st">'INT2S'</span>, overwrite<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># example with the calc function</span></span>
<span class="r-in"><span class="va">a</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span class="r-in"><span class="va">f3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">+</span><span class="va">a</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="va">z1</span> <span class="op">&lt;-</span> <span class="fu">clusterR</span><span class="op">(</span><span class="va">s</span>, <span class="va">calc</span>, args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun<span class="op">=</span><span class="va">f3</span><span class="op">)</span>, export<span class="op">=</span><span class="st">'a'</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># for some raster functions that use another function as an argument </span></span>
<span class="r-in"><span class="co"># you can write your own parallel function instead of using clusterR</span></span>
<span class="r-in"><span class="co"># get cluster object created with beginCluster</span></span>
<span class="r-in"><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="programming.html">getCluster</a></span><span class="op">(</span><span class="op">)</span>  </span>
<span class="r-in"></span>
<span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span><span class="va">cl</span>, <span class="st">"a"</span><span class="op">)</span></span>
<span class="r-in"><span class="va">z2</span> <span class="op">&lt;-</span> <span class="fu"><a href="calc.html">calc</a></span><span class="op">(</span><span class="va">s</span>, fun<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parApply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="va">x</span>, <span class="fl">1</span>, <span class="va">f3</span><span class="op">)</span><span class="op">}</span> <span class="op">)</span></span>
<span class="r-in"><span class="co"># set flag that cluster is available again</span></span>
<span class="r-in"><span class="fu"><a href="programming.html">returnCluster</a></span><span class="op">(</span><span class="op">)</span></span>
<span class="r-in"><span class="co">#</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co"># done with cluster object    </span></span>
<span class="r-in"><span class="fu">endCluster</span><span class="op">(</span><span class="op">)</span></span>
<span class="r-in"><span class="op">}</span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Robert J. Hijmans.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

      </footer></div>

  


  

  </body></html>

